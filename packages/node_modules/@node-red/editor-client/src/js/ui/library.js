/**
 * Copyright JS Foundation and other contributors, http://js.foundation
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 **/
RED.library = (function() {

    var exportToLibraryDialog;
    var loadLibraryBrowser;
    var saveLibraryBrowser;
    var libraryEditor;
    var activeLibrary;

    var _libraryLookup = '<div id="node-dialog-library-load" class="hide">'+
        '<form class="form-horizontal">'+
            '<div style="height: 500px; position:relative; ">'+
                '<div id="node-dialog-library-load-browser"></div>'+
                '<div id="node-dialog-library-load-preview">'+
                    '<div id="node-dialog-library-load-preview-details">'+
                        '<table id="node-dialog-library-load-preview-details-table" class="node-info"></table>'+
                    '</div>'+
                    '<div id="node-dialog-library-load-preview-text"></div>'+
                '</div>'+
            '</div>'+
        '</form>'+
    '</div>'


    var _librarySave = '<div id="node-dialog-library-save" class="hide">'+
        '<form class="form-horizontal">'+
        '<div style="height: 400px; position:relative; ">'+
            '<div id="node-dialog-library-save-browser"></div>'+
            '<div class="form-row">'+
                '<label data-i18n="clipboard.export.exportAs"></label><input id="node-dialog-library-save-filename" type="text">'+
            '</div>'+
        '</div>'+
        '</form>'+
    '</div>'

    function saveToLibrary() {
        var elementPrefix = activeLibrary.elementPrefix || "node-input-";
        var name = $("#"+elementPrefix+"name").val().trim();
        if (name === "") {
            name = RED._("library.unnamedType",{type:activeLibrary.type});
        }
        var filename = $("#node-dialog-library-save-filename").val().trim()
        var selectedPath = saveLibraryBrowser.getPath();
        var queryArgs = [];
        var data = {};
        for (var i=0; i<activeLibrary.fields.length; i++) {
            var field = activeLibrary.fields[i];
            if (field == "name") {
                data.name = name;
            } else {
                data[field] = $("#"+elementPrefix+field).val();
            }
        }
        data.text = activeLibrary.editor.getValue();
        var saveFlow = function() {
            $.ajax({
                url:"library/"+activeLibrary.url+'/'+selectedPath.path + filename,
                type: "POST",
                data: JSON.stringify(data),
                contentType: "application/json; charset=utf-8"
            }).done(function(data,textStatus,xhr) {
                RED.notify(RED._("library.savedType", {type:activeLibrary.type}),"success");
            }).fail(function(xhr,textStatus,err) {
                if (xhr.status === 401) {
                    RED.notify(RED._("library.saveFailed",{message:RED._("user.notAuthorized")}),"error");
                } else {
                    RED.notify(RED._("library.saveFailed",{message:xhr.responseText}),"error");
                }
            });
        }
        if (selectedPath.files) {
            var exists = false;
            selectedPath.files.forEach(function(f) {
                if (f.label === filename) {
                    exists = true;
                }
            });
            if (exists) {
                $( "#node-dialog-library-save" ).dialog("close");
                var notification = RED.notify(RED._("clipboard.export.exists",{file:RED.utils.sanitize(filename)}),{
                    type: "warning",
                    fixed: true,
                    buttons: [{
                        text: RED._("common.label.cancel"),
                        click: function() {
                            notification.hideNotification()
                            $( "#node-dialog-library-save" ).dialog( "open" );
                        }
                    },{
                        text: RED._("clipboard.export.overwrite"),
                        click: function() {
                            notification.hideNotification()
                            saveFlow();
                        }
                    }]
                });
            } else {
                saveFlow();
            }
        } else {
            saveFlow();
        }
    }

    function loadFlowLibrary() {
        $.getJSON("library/flows",function(data) {
            //console.log(data);

            var buildMenu = function(data,root) {
                var i;
                var li;
                var a;
                var ul = document.createElement("ul");
                if (root === "") {
                    ul.id = "menu-item-import-library-submenu";
                }
                ul.className = "dropdown-menu";
                if (data.d) {
                    for (i in data.d) {
                        if (data.d.hasOwnProperty(i)) {
                            li = document.createElement("li");
                            li.className = "dropdown-submenu pull-left";
                            a = document.createElement("a");
                            a.href="#";
                            var label = i.replace(/^@.*\//,"").replace(/^node-red-contrib-/,"").replace(/^node-red-node-/,"").replace(/-/g," ").replace(/_/g," ");
                            a.innerText = label;
                            li.appendChild(a);
                            li.appendChild(buildMenu(data.d[i],root+(root!==""?"/":"")+i));
                            ul.appendChild(li);
                        }
                    }
                }
                if (data.f) {
                    for (i in data.f) {
                        if (data.f.hasOwnProperty(i)) {
                            li = document.createElement("li");
                            a = document.createElement("a");
                            a.href="#";
                            a.innerText = data.f[i];
                            a.flowName = root+(root!==""?"/":"")+data.f[i];
                            a.onclick = function() {
                                $.get('library/flows/'+this.flowName, function(data) {
                                    RED.view.importNodes(data);
                                });
                            };
                            li.appendChild(a);
                            ul.appendChild(li);
                        }
                    }
                }
                return ul;
            };
            var examples;
            if (data.d && data.d._examples_) {
                examples = data.d._examples_;
                delete data.d._examples_;
            }
            var menu = buildMenu(data,"");
            $("#menu-item-import-examples").remove();
            if (examples) {
                RED.menu.addItem("menu-item-import",{id:"menu-item-import-examples",label:RED._("menu.label.examples"),options:[]})
                $("#menu-item-import-examples-submenu").replaceWith(buildMenu(examples,"_examples_"));
            }
            //TODO: need an api in RED.menu for this
            $("#menu-item-import-library-submenu").replaceWith(menu);
        });
    }

    function loadLibraryFolder(url,root,done) {
        $.getJSON("library/"+url+"/"+root,function(data) {
            var files = [];
            var items = data.reduce(function(acc,d) {
                if (typeof d === "string") {
                    acc.push({
                        icon: 'fa fa-folder',
                        label: d,
                        path: root+d+"/",
                        children: function(item,done) {
                            loadLibraryFolder(url,root+d+"/", function(files,children) {
                                item.files = files;
                                item.children = children; // TODO: should this be done by treeList for us
                                done(children);
                            })
                        }
                    });
                } else {
                    files.push({
                        icon: 'fa fa-file-o',
                        label: d.fn,
                        path: root+d.fn,
                        props: d
                    })
                }
                return acc;
            },[]);
            done(files,items);
        });
    }

    var validateExportFilenameTimeout;
    function validateExportFilename(filenameInput) {
        if (validateExportFilenameTimeout) {
            clearTimeout(validateExportFilenameTimeout);
        }
        validateExportFilenameTimeout = setTimeout(function() {
            var filename = filenameInput.val().trim();
            var valid = filename.length > 0 && !/[\/\\]/.test(filename);
            if (valid) {
                filenameInput.removeClass("input-error");
                $("#node-dialog-library-save-button").button("enable");
            } else {
                filenameInput.addClass("input-error");
                $("#node-dialog-library-save-button").button("disable");
            }
        },100);
    }

    function createUI(options) {
        var libraryData = {};
        var selectedLibraryItem = null;
        var elementPrefix = options.elementPrefix || "node-input-";

        // Orion editor has set/getText
        // ACE editor has set/getValue
        // normalise to set/getValue
        if (options.editor.setText) {
            // Orion doesn't like having pos passed in, so proxy the call to drop it
            options.editor.setValue = function(text,pos) {
                options.editor.setText.call(options.editor,text);
            }
        }
        if (options.editor.getText) {
            options.editor.getValue = options.editor.getText;
        }

        // Add the library button to the name <input> in the edit dialog
        $('#'+elementPrefix+"name").css("width","calc(100% - 52px)").after(
            '<div class="btn-group" style="margin-left:5px;">'+
            '<a id="node-input-'+options.type+'-lookup" class="editor-button" data-toggle="dropdown"><i class="fa fa-book"></i> <i class="fa fa-caret-down"></i></a>'+
            '<ul class="dropdown-menu pull-right" role="menu">'+
            '<li><a id="node-input-'+options.type+'-menu-open-library" tabindex="-1" href="#">'+RED._("library.openLibrary")+'</a></li>'+
            '<li><a id="node-input-'+options.type+'-menu-save-library" tabindex="-1" href="#">'+RED._("library.saveToLibrary")+'</a></li>'+
            '</ul></div>'
        );

        $('#node-input-'+options.type+'-menu-open-library').click(function(e) {
            activeLibrary = options;
            loadLibraryFolder(options.url, "", function(files,items) {
                var listing = [{
                    icon: 'fa fa-archive',
                    label: "Local",
                    path: "",
                    expanded: true,
                    writable: false,
                    children: [{
                        icon: 'fa fa-cube',
                        label: options.type,
                        path: options.type+"/",
                        expanded: true,
                        children: items,
                        files: files
                    }]
                }]
                loadLibraryBrowser.data(listing);
            });
            libraryEditor = ace.edit('node-dialog-library-load-preview-text');
            libraryEditor.setTheme("ace/theme/tomorrow");
            if (options.mode) {
                libraryEditor.getSession().setMode(options.mode);
            }
            libraryEditor.setOptions({
                readOnly: true,
                highlightActiveLine: false,
                highlightGutterLine: false
            });
            libraryEditor.renderer.$cursorLayer.element.style.opacity=0;
            libraryEditor.$blockScrolling = Infinity;


            $( "#node-dialog-library-load" ).dialog("option","title",RED._("library.typeLibrary", {type:options.type})).dialog( "open" );
            e.preventDefault();
        });

        $('#node-input-'+options.type+'-menu-save-library').click(function(e) {
            activeLibrary = options;
            //var found = false;
            var name = $("#"+elementPrefix+"name").val().replace(/(^\s*)|(\s*$)/g,"");
            var filename = name.replace(/[^\w-]/g,"-");
            if (filename === "") {
                filename = "unnamed-"+options.type;
            }
            $("#node-dialog-library-save-filename").attr("value",filename+".js");

            loadLibraryFolder(options.url, "", function(files,items) {
                var listing = [{
                    icon: 'fa fa-archive',
                    label: "Local",
                    path: "",
                    expanded: true,
                    writable: false,
                    children: [{
                        icon: 'fa fa-cube',
                        label: options.type,
                        path: options.type+"/",
                        expanded: true,
                        children: items,
                        files: files
                    }]
                }]
                saveLibraryBrowser.data(listing);
            });

            $( "#node-dialog-library-save" ).dialog( "open" );
            e.preventDefault();
        });


    }

    function exportFlow() {
        console.warn("Deprecated call to RED.library.export");
    }

    function createBrowser(options) {
        var panes = $('<div class="red-ui-library-browser"></div>').appendTo(options.container);
        var dirsPane = $('<div class="red-ui-panel"></div>').appendTo(panes);
        var filesPane = $('<div class="red-ui-panel"></div>').appendTo(panes);
        //
        // '<div id="clipboard-dialog-export-tab-library-panes">'+
        //     '<div class="red-ui-panel" id="clipboard-dialog-tab-library-sources-pane"></div>'+
        //     '<div class="red-ui-panel" id="clipboard-dialog-tab-library-listing-pane"></div>'+
        // '</div>'+
        RED.panels.create({
            container:panes,
            dir: "horizontal"
        });
        var dirList = $("<div>").css({width: "100%", height: "100%"}).appendTo(dirsPane)
            .treeList({}).on('treelistselect', function(event, item) {
                fileList.treeList('data',item.files||[]);
                if (addButton) {
                    if (item.writable === false) {
                        addButton.prop('disabled', true);
                    } else {
                        addButton.prop('disabled', false);
                    }
                }
                if (options.onpathselect) {
                    options.onpathselect(item);
                }
            }).on('treelistchildrenloaded', function(event) {
                var selected = dirList.treeList('selected');
                fileList.treeList('data',selected.files||[]);
            });
        var addButton;
        if (options.addFolderButton) {
            var tools = $("<div>").css({position: "absolute",bottom:"3px",left:"3px"}).appendTo(dirsPane)
            addButton= $('<button type="button" class="editor-button editor-button-small"><i class="fa fa-plus"> <i class="fa fa-folder-o"></button>').appendTo(tools).click(function(e) {
                var selected = dirList.treeList('selected');

                var defaultFolderName = "new-folder";
                var defaultFolderNameMatches = {};
                selected.children.forEach(function(c) {
                    if (/^new-folder/.test(c.label)) {
                        defaultFolderNameMatches[c.label] = true
                    }
                });
                var folderIndex = 2;
                while(defaultFolderNameMatches[defaultFolderName]) {
                    defaultFolderName = "new-folder-"+(folderIndex++)
                }

                selected.treeList.expand();
                var input = $('<input type="text" class="red-ui-treeList-input">').val(defaultFolderName);
                var newItem = {
                    icon: "fa fa-folder-o",
                    children:[],
                    path: selected.path,
                    element: input
                }
                var confirmAdd = function() {
                    var val = input.val().trim();
                    if (val === "") {
                        cancelAdd();
                        return;
                    } else {
                        for (var i=0;i<selected.children.length;i++) {
                            if (selected.children[i].label === val) {
                                cancelAdd();
                                return;
                            }
                        }
                    }
                    newItem.treeList.remove();
                    selected.treeList.addChild({
                        icon: "fa fa-folder",
                        children:[],
                        label: val,
                        path: newItem.path+val+"/"
                    });
                }
                var cancelAdd = function() {
                    newItem.treeList.remove();
                }
                input.on('keydown', function(evt) {
                    if (evt.keyCode === 13) {
                        evt.stopPropagation();
                        confirmAdd();
                    } else if (evt.keyCode === 27) {
                        evt.stopPropagation();
                        cancelAdd();
                    }
                })
                input.blur(function() {
                    confirmAdd();
                })
                selected.treeList.addChild(newItem);
                setTimeout(function() {
                    input.focus();
                    input.select();
                },200);
            });
        }

        var fileList = $("<div>").css({width: "100%", height: "100%"}).appendTo(filesPane)
            .treeList({}).on('treelistselect', function(event, item) {
                if (options.onselect) {
                    options.onselect(item);
                }
            })
        return {
            getFile: function() {
                return fileList.treeList('selected');
            },
            getPath: function() {
                return dirList.treeList('selected');
            },
            data: function(content) {
                dirList.treeList('data',content);
                setTimeout(function() {
                    dirList.treeList('select',content[0]);
                },100);
            }
        }
    }

    return {
        init: function() {

            $(_librarySave).appendTo(document.body);
            $(_libraryLookup).appendTo(document.body);

            $( "#node-dialog-library-save" ).dialog({
                title: RED._("library.saveToLibrary"),
                modal: true,
                autoOpen: false,
                width: 800,
                resizable: false,
                buttons: [
                    {
                        text: RED._("common.label.cancel"),
                        click: function() {
                            $( this ).dialog( "close" );
                        }
                    },
                    {
                        id: "node-dialog-library-save-button",
                        text: RED._("common.label.save"),
                        class: "primary",
                        click: function() {
                            saveToLibrary(false);
                            $( this ).dialog( "close" );
                        }
                    }
                ],
                open: function(e) {
                    $(this).parent().find(".ui-dialog-titlebar-close").hide();
                }
            });

            saveLibraryBrowser = RED.library.createBrowser({
                container: $("#node-dialog-library-save-browser"),
                addFolderButton: true,
                onpathselect: function(item) {
                    try {
                        if (item.writable === false) {
                            $("#node-dialog-library-save-button").button("disable");
                        } else {
                            $("#node-dialog-library-save-button").button("enable");
                        }
                    } catch(err) {}
                },
                onselect: function(file) {
                    $("#node-dialog-library-save-filename").val(file.label);
                }
            });
            $("#node-dialog-library-save-filename").keyup(function() { validateExportFilename($(this))});
            $("#node-dialog-library-save-filename").on('paste',function() { var input = $(this); setTimeout(function() { validateExportFilename(input)},10)});

            $( "#node-dialog-library-load" ).dialog({
                modal: true,
                autoOpen: false,
                width: 800,
                resizable: false,
                buttons: [
                    {
                        text: RED._("common.label.cancel"),
                        click: function() {
                            $( this ).dialog( "close" );
                        }
                    },
                    {
                        text: RED._("common.label.load"),
                        class: "primary",
                        click: function() {
                            if (selectedLibraryItem) {
                                for (var i=0; i<options.fields.length; i++) {
                                    var field = options.fields[i];
                                    $("#"+elementPrefix+field).val(selectedLibraryItem[field]);
                                }
                                options.editor.setValue(libraryEditor.getValue(),-1);
                            }
                            $( this ).dialog( "close" );
                        }
                    }
                ],
                open: function(e) {
                    $(this).parent().find(".ui-dialog-titlebar-close").hide();
                },
                close: function(e) {
                    if (libraryEditor) {
                        libraryEditor.destroy();
                        libraryEditor = null;
                    }
                }
            });
            loadLibraryBrowser = RED.library.createBrowser({
                container: $("#node-dialog-library-load-browser"),
                onselect: function(file) {
                    var table = $("#node-dialog-library-load-preview-details-table").empty();

                    if (file && file.label) {
                        $.get("library/"+activeLibrary.url+"/"+file.path, function(data) {
                            //TODO: nls + sanitize
                            var propRow = $('<tr class="node-info-node-row"><td>Type</td><td></td></tr>').appendTo(table);
                            $(propRow.children()[1]).text(activeLibrary.type);
                            if (file.props.hasOwnProperty('name')) {
                                propRow = $('<tr class="node-info-node-row"><td>Name</td><td>'+file.props.name+'</td></tr>').appendTo(table);
                                $(propRow.children()[1]).text(file.props.name);
                            }
                            for (var p in file.props) {
                                if (file.props.hasOwnProperty(p) && p !== 'name' && p !== 'fn') {
                                    propRow = $('<tr class="node-info-node-row"><td></td><td></td></tr>').appendTo(table);
                                    $(propRow.children()[0]).text(p);
                                    RED.utils.createObjectElement(file.props[p]).appendTo(propRow.children()[1]);
                                }
                            }
                            libraryEditor.setValue(data,-1);
                        });
                    } else {
                        libraryEditor.setValue("",-1);
                    }
                }
            });


            if (RED.settings.theme("menu.menu-item-import-library") !== false) {
                loadFlowLibrary();
            }
        },
        create: createUI,
        loadFlowLibrary: loadFlowLibrary,
        createBrowser:createBrowser,
        export: exportFlow
    }
})();
