<!--
  Copyright JS Foundation and other contributors, http://js.foundation

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->

<!DOCTYPE html>

<script type="text/x-red" data-template-name="sort">

    <div class="form-row">
        <label><i class="fa fa-dot-circle-o"></i> <span data-i18n="sort.key-type"></span></label>
        <select id="node-input-keyType" style="width:200px;">
            <option value="payload" data-i18n="sort.payload"></option>
            <option value="exp" data-i18n="sort.exp"></option>
        </select>
    </div>

    <div class="node-row-sort-key">
        <div class="form-row">
            <label><i class="fa fa-filter"></i> <span data-i18n="sort.key-exp"></span></label>
            <input type="text" id="node-input-key" style="width:70%;">
        </div>
    </div>
    
    <div class="form-row">
        <label><i class="fa fa-random"></i>  <span data-i18n="sort.order"></span></label>
        <select id="node-input-order" style="width:200px;">
            <option value="ascending" data-i18n="sort.ascending"></option>
            <option value="descending" data-i18n="sort.descending"></option>
        </select>
    </div>

    <div class="form-row" id="node-as_num">
        <label>&nbsp;</label>
        <input type="checkbox" id="node-input-as_num" style="display: inline-block; width: auto; vertical-align: top;">
        <label for="node-input-as_num" style="width: 70%;" data-i18n="sort.as-number"></label>
    </div>

    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="node-red:common.label.name"></span></label>
        <input type="text" id="node-input-name" data-i18n="[placeholder]node-red:common.label.name">
    </div>
</script>

<script type="text/x-red" data-help-name="sort">
    <p>A function that sorts a sequence of messages or payload of array type.</p>
    <p>When paired with the <b>split</b> node, it will reorder the
    messages.</p>
    <p>The sorting order can be:</p>
    <ul>
        <li><b>ascending</b>,</li>
        <li><b>descending</b>.</li>
    </ul>
    <p>For numbers, numerical ordering can be specified by a checkbox.</p>
    <p>Sort key can be <code>payload</code> or any JSONata expression for sorting messages, element value or any JSONata expression for sorting payload of array type.</p>
    <p>The sort node relies on the received messages to have <code>msg.parts</code> set for sorting messages. The split node generates this property, but can be manually created. It has the following properties:</p>
    <p>
        <ul>
            <li><code>id</code> - an identifier for the group of messages</li>
            <li><code>index</code> - the position within the group</li>
            <li><code>count</code> - the total number of messages in the group</li>
        </ul>
    </p>
    <p><b>Note:</b> This node internally keeps messages for its operation.  In order to prevent unexpected memory usage, maximum number of messages kept can be specified.  Default is no limit on number of messages.
        <ul>
            <li><code>sortMaxKeptMsgsCount</code> property set in <b>settings.js</b>.</li>
        </ul>
    </p>
</script>

<script type="text/javascript">
    RED.nodes.registerType('sort',{
        category: 'function',
        color:"#E2D96E",
        defaults: {
            name: { value:"" },
            order: { value:"ascending" },
            as_num : { value:false },
            keyType : { value:"payload" },
            key : { value:"" }
        },
        inputs:1,
        outputs:1,
        icon: "sort.png",
        label: function() {
            return this.name || "sort";
        },
        labelStyle: function() {
            return this.name ? "node_label_italic" : "";
        },
        oneditprepare: function() {
            $("#node-input-key").typedInput({default:'jsonata', types:['jsonata']});
            $("#node-input-keyType").change(function(e) {
                var val = $(this).val();
                $(".node-row-sort-key").toggle(val === 'exp');
            });
            $("#node-input-keyType").change();
            $("#node-input-order").change();
        }
    });
</script>
