
<script type="text/x-red" data-template-name="rpi-gpio in">
    <style>
        .pinTable {
            width: 300px;
            display: inline-table;
            font-size: 13px;
            height: 380px;
            min-height: 380px;
            max-height: 380px;
        }
        .pinTableBody {
            width: 300px;
            display: table-row-group;
            line-height: 12px;
        }
        .pinTableRow {
            width: 300;
            display: table-row;
            height: 14px;
        }
        .pinTableCellL {
            width: 150px;
            display: table-cell;
            text-align: right;
            padding-right: 4px;
            vertical-align: top;
            border: 1px solid #444;
        }
        .pinTableCellR {
            width: 150px;
            display: table-cell;
            text-align: left;
            padding-left: 4px;
            vertical-align: top;
            border: 1px solid #000;
        }
        .pinColorPower {
            background-color:#FECBCE;
        }
        .pinColorGround {
            background-color:#DDDDDD;
        }
        .pinColorGPIO {
            background-color:#BFEBBF;
        }
        .pinColorDual {
            background-color:#D0E6F4;
        }
        .pinColorSD {
            background-color:#FFFDD0;
        }
    </style>
    <div class="form-row">
        <label><i class="fa fa-circle"></i> <span data-i18n="rpi-gpio.pinname"></span></label>
        <input type="text" id="node-input-pin" style="display:none;">
        <div class="pinTable">
            <div class="pinTableBody"><form id="pinform" style="height:380px; max-height:380px; margin:initial;">
                <div class="pinTableRow">
                    <div class="pinTableCellL pinColorPower">3.3V Power - 1 <input disabled type="radio" name="pins" value="" style="width:auto;"></div>
                    <div class="pinTableCellR pinColorPower"><input disabled type="radio" name="pins" value="" style="width:auto;"> 2 - 5V Power</div>
                </div>
                <div class="pinTableRow">
                    <div class="pinTableCellL pinColorDual">SDA1 - GPIO02 - 3 <input type="radio" name="pins" value="2" style="width:auto;"></div>
                    <div class="pinTableCellR pinColorPower"><input disabled type="radio" name="pins" value="" style="width:auto;"> 4 - 5V Power</div>
                </div>
                <div class="pinTableRow">
                    <div class="pinTableCellL pinColorDual">SCL1 - GPIO03 - 5 <input type="radio" name="pins" value="3" style="width:auto;"></div>
                    <div class="pinTableCellR pinColorGround"><input disabled type="radio" name="pins" value="" style="width:auto;"> 6 - Ground</div>
                </div>
                <div class="pinTableRow">
                    <div class="pinTableCellL pinColorGPIO">GPIO04 - 7 <input type="radio" name="pins" value="4" style="width:auto;"></div>
                    <div class="pinTableCellR pinColorDual"><input type="radio" name="pins" value="14" style="width:auto;"> 8 - GPIO14 - TxD</div>
                </div>
                <div class="pinTableRow">
                    <div class="pinTableCellL pinColorGround">Ground - 9 <input disabled type="radio" name="pins" value="" style="width:auto;"></div>
                    <div class="pinTableCellR pinColorDual"><input type="radio" name="pins" value="15" style="width:auto;"> 10 - GPIO15 - RxD</div>
                </div>
                <div class="pinTableRow">
                    <div class="pinTableCellL pinColorGPIO">GPIO17 - 11 <input type="radio" name="pins" value="17" style="width:auto;"></div>
                    <div class="pinTableCellR pinColorGPIO"><input type="radio" name="pins" value="18" style="width:auto;"> 12 - GPIO18</div>
                </div>
                <div class="pinTableRow">
                    <div class="pinTableCellL pinColorGPIO">GPIO27 - 13 <input type="radio" name="pins" value="27" style="width:auto;"></div>
                    <div class="pinTableCellR pinColorGround"><input disabled type="radio" name="pins" value="" style="width:auto;"> 14 - Ground</div>
                </div>
                <div class="pinTableRow">
                    <div class="pinTableCellL pinColorGPIO">GPIO22 - 15 <input type="radio" name="pins" value="22" style="width:auto;"></div>
                    <div class="pinTableCellR pinColorGPIO"><input type="radio" name="pins" value="23" style="width:auto;"> 16 - GPIO23</div>
                </div>
                <div class="pinTableRow">
                    <div class="pinTableCellL pinColorPower">3.3V Power - 17 <input disabled type="radio" name="pins" value="" style="width:auto;"></div>
                    <div class="pinTableCellR pinColorGPIO"><input type="radio" name="pins" value="24" style="width:auto;"> 18 - GPIO24</div>
                </div>
                <div class="pinTableRow">
                    <div class="pinTableCellL pinColorDual">MOSI - GPIO10 - 19 <input type="radio" name="pins" value="10" style="width:auto;"></div>
                    <div class="pinTableCellR pinColorGround"><input disabled type="radio" name="pins" value="" style="width:auto;"> 20 - Ground</div>
                </div>
                <div class="pinTableRow">
                    <div class="pinTableCellL pinColorDual">MISO - GPIO09 - 21 <input type="radio" name="pins" value="9" style="width:auto;"></div>
                    <div class="pinTableCellR pinColorGPIO"><input type="radio" name="pins" value="25" style="width:auto;"> 22 - GPIO25</div>
                </div>
                <div class="pinTableRow">
                    <div class="pinTableCellL pinColorDual">SCLK - GPIO11 - 23 <input type="radio" name="pins" value="11" style="width:auto;"></div>
                    <div class="pinTableCellR pinColorDual"><input type="radio" name="pins" value="8" style="width:auto;"> 24 - GPIO8 - CE0</div>
                </div>
                <div class="pinTableRow">
                    <div class="pinTableCellL pinColorGround">Ground - 25 <input disabled type="radio" name="pins" value="" style="width:auto;"></div>
                    <div class="pinTableCellR pinColorDual"><input type="radio" name="pins" value="7" style="width:auto;"> 26 - GPIO7 - CE1</div>
                </div>
                <div class="pinTableRow">
                    <div class="pinTableCellL pinColorSD">SD - 27 <input disabled type="radio" name="pins" value="" style="width:auto;"></div>
                    <div class="pinTableCellR pinColorSD"><input disabled type="radio" name="pins" value="" style="width:auto;"> 28 - SC</div>
                </div>
                <div class="pinTableRow">
                    <div class="pinTableCellL pinColorGPIO">GPIO05 - 29 <input type="radio" name="pins" value="5" style="width:auto;"></div>
                    <div class="pinTableCellR pinColorGround"><input disabled type="radio" name="pins" value="" style="width:auto;"> 30 - Ground</div>
                </div>
                <div class="pinTableRow">
                    <div class="pinTableCellL pinColorGPIO">GPIO06 - 31 <input type="radio" name="pins" value="6" style="width:auto;"></div>
                    <div class="pinTableCellR pinColorGPIO"><input type="radio" name="pins" value="12" style="width:auto;"> 32 - GPIO12</div>
                </div>
                <div class="pinTableRow">
                    <div class="pinTableCellL pinColorGPIO">GPIO13 - 33 <input type="radio" name="pins" value="13" style="width:auto;"></div>
                    <div class="pinTableCellR pinColorGround"><input disabled type="radio" name="pins" value="" style="width:auto;"> 34 - Ground</div>
                </div>
                <div class="pinTableRow">
                    <div class="pinTableCellL pinColorGPIO">GPIO19 - 35 <input type="radio" name="pins" value="19" style="width:auto;"></div>
                    <div class="pinTableCellR pinColorGPIO"><input type="radio" name="pins" value="16" style="width:auto;"> 36 - GPIO16</div>
                </div>
                <div class="pinTableRow">
                    <div class="pinTableCellL pinColorGPIO">GPIO26 - 37 <input type="radio" name="pins" value="26" style="width:auto;"></div>
                    <div class="pinTableCellR pinColorGPIO"><input type="radio" name="pins" value="20" style="width:auto;"> 38 - GPIO20</div>
                </div>
                <div class="pinTableRow">
                    <div class="pinTableCellL pinColorGround">Ground - 39 <input disabled type="radio" name="pins" value="" style="width:auto;"></div>
                    <div class="pinTableCellR pinColorGPIO"><input type="radio" name="pins" value="21" style="width:auto;"> 40 - GPIO21</div>
                </div>
            </form></div>
        </div>
    </div>
    <div class="form-row">
        <label for="node-input-intype"><i class="fa fa-level-up"></i> <span data-i18n="rpi-gpio.label.resistor"></span></label>
        <select type="text" id="node-input-intype" style="width:100px;">
        <option value="tri" data-i18n="rpi-gpio.resistor.none"></option>
        <option value="up" data-i18n="rpi-gpio.resistor.pullup"></option>
        <option value="down" data-i18n="rpi-gpio.resistor.pulldown"></option>
        </select>
        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span data-i18n="rpi-gpio.label.debounce"></span>
        <input type="text" id="node-input-debounce" style="width:47px; text-align:right"/>&nbsp;mS
    </div>
    <div class="form-row">
        <label>&nbsp;</label>
        <input type="checkbox" id="node-input-read" style="display: inline-block; width: auto; vertical-align: top;">
        <label for="node-input-read" style="width:70%;"><span data-i18n="rpi-gpio.label.readinitial"></span></label>
    </div>
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="common.label.name"></span></label>
        <input type="text" id="node-input-name" data-i18n="[placeholder]common.label.name">
    </div>
    <div class="form-tips" id="pin-tip"><span data-i18n="[html]rpi-gpio.tip.pin"></span></div>
    <div class="form-tips"><span data-i18n="[html]rpi-gpio.tip.in"></span></div>
</script>

<script type="text/x-red" data-help-name="rpi-gpio in">
    <p>Raspberry Pi input node. Generates a <code>msg.payload</code> with either a
    0 or 1 depending on the state of the input pin.</p>
    <h3>Outputs</h3>
    <dl class="message-properties">
        <dt>payload <span class="property-type">number</span></dt>
        <dd>the payload will be a 1 or a 0.</dd>
        <dt>topic <span class="property-type">string</span></dt>
        <dd>the topic will be set to `pi/{the pin number}`.</dd>
    </dl>
    <h3>Details</h3>
    <p>You may also enable the input pullup resistor or the pulldown resistor.</p>
    <p>Requires the RPi.GPIO python library version 0.5.10 (or better) in order to work.</p>
</script>

<script type="text/javascript">
    var bcm2pin = {
        "2":"3", "3":"5", "4":"7", "14":"8", "15":"10", "17":"11", "18":"12", "27":"13", "22":"15",
        "23":"16", "24":"18", "10":"19", "9":"21", "25":"22", "11":"23", "8":"24", "7":"26",
        "5":"29", "6":"31", "12":"32", "13":"33", "19":"35", "16":"36", "26":"37", "20":"38", "21":"40"
    };
    var pinsInUse = {};
    RED.nodes.registerType('rpi-gpio in',{
        category: 'Raspberry Pi',
        color:"#c6dbef",
        defaults: {
            name: { value:"" },
            pin: { value:"tri",required:true,validate:RED.validators.number() },
            intype: { value:"tri" },
            debounce: { value:"25" },
            read: { value:false }
        },
        inputs:0,
        outputs:1,
        icon: "rpi.png",
        info: function() {
            if ( Object.keys(pinsInUse).length !== 0 ) {
                return "**Pins in use** : "+Object.keys(pinsInUse);
            }
            else { return ""; }
        },
        label: function() {
            var suf = "";
            if (this.intype === "up") { suf = "↑ "}
            if (this.intype === "down") { suf = "↓ "}
            return this.name || "PIN: "+suf+bcm2pin[this.pin] ;
        },
        labelStyle: function() {
            return this.name?"node_label_italic":"";
        },
        outputLabels: function() { return "GPIO"+this.pin; },
        oneditprepare: function() {
            var pinnow = this.pin;
            var pintip = this._("rpi-gpio.tip.pin");
            var pinname = this._("rpi-gpio.pinname");
            var alreadyuse = this._("rpi-gpio.alreadyuse");
            var alreadyset = this._("rpi-gpio.alreadyset");

            $.getJSON('rpi-pins/'+this.id,function(data) {
                pinsInUse = data || {};
                $('#pin-tip').html(pintip + Object.keys(data));
            });
            $("#node-input-pin").change(function() {
                if ($("#node-input-pin").val()) {
                    $("#pinform input[value="+$("#node-input-pin").val()+"]").prop('checked', true);
                }
                var pinnew = $("#node-input-pin").val();
                if ((pinnew) && (pinnew !== pinnow)) {
                    if (pinsInUse.hasOwnProperty(pinnew)) {
                        RED.notify(pinname+" "+pinnew+" "+alreadyuse,"warn");
                    }
                    pinnow = pinnew;
                }
            });
            $("#node-input-intype").change(function() {
                var newtype = $("#node-input-intype").val();
                if ((pinsInUse.hasOwnProperty(pinnow)) && (pinsInUse[pinnow] !== newtype)) {
                    RED.notify(pinname+" "+pinnow+" "+alreadyset+" "+pinsInUse[pinnow],"error");
                }
            });
            $('#pinform input').on('change', function() {
                this.pin = $("#pinform input[type='radio']:checked").val();
                $("#node-input-pin").val(this.pin);
            });
        }
    });
</script>

<script type="text/x-red" data-template-name="rpi-gpio out">
    <style>
        .pinTable {
            width: 300px;
            display: inline-table;
            font-size: 13px;
            height: 380px;
            min-height: 380px;
            max-height: 380px;
        }
        .pinTableBody {
            width: 300px;
            display: table-row-group;
            line-height: 12px;
        }
        .pinTableRow {
            width: 300;
            display: table-row;
            height: 14px;
        }
        .pinTableCellL {
            width: 150px;
            display: table-cell;
            text-align: right;
            padding-right: 4px;
            vertical-align: top;
            border: 1px solid #444;
        }
        .pinTableCellR {
            width: 150px;
            display: table-cell;
            text-align: left;
            padding-left: 4px;
            vertical-align: top;
            border: 1px solid #000;
        }
        .pinColorPower {
            background-color:#FECBCE;
        }
        .pinColorGround {
            background-color:#DDDDDD;
        }
        .pinColorGPIO {
            background-color:#BFEBBF;
        }
        .pinColorDual {
            background-color:#D0E6F4;
        }
        .pinColorSD {
            background-color:#FFFDD0;
        }
    </style>
    <div class="form-row">
        <label><i class="fa fa-circle"></i> <span data-i18n="rpi-gpio.pinname"></span></label>
        <input type="text" id="node-input-pin" style="display:none;">
        <div class="pinTable">
            <div class="pinTableBody"><form id="pinform" style="height:380px; max-height:380px; margin:initial;">
                <div class="pinTableRow">
                    <div class="pinTableCellL pinColorPower">3.3V Power - 1 <input disabled type="radio" name="pins" value="" style="width:auto;"></div>
                    <div class="pinTableCellR pinColorPower"><input disabled type="radio" name="pins" value="" style="width:auto;"> 2 - 5V Power</div>
                </div>
                <div class="pinTableRow">
                    <div class="pinTableCellL pinColorDual">SDA1 - GPIO02 - 3 <input type="radio" name="pins" value="2" style="width:auto;"></div>
                    <div class="pinTableCellR pinColorPower"><input disabled type="radio" name="pins" value="" style="width:auto;"> 4 - 5V Power</div>
                </div>
                <div class="pinTableRow">
                    <div class="pinTableCellL pinColorDual">SCL1 - GPIO03 - 5 <input type="radio" name="pins" value="3" style="width:auto;"></div>
                    <div class="pinTableCellR pinColorGround"><input disabled type="radio" name="pins" value="" style="width:auto;"> 6 - Ground</div>
                </div>
                <div class="pinTableRow">
                    <div class="pinTableCellL pinColorGPIO">GPIO04 - 7 <input type="radio" name="pins" value="4" style="width:auto;"></div>
                    <div class="pinTableCellR pinColorDual"><input type="radio" name="pins" value="14" style="width:auto;"> 8 - GPIO14 - TxD</div>
                </div>
                <div class="pinTableRow">
                    <div class="pinTableCellL pinColorGround">Ground - 9 <input disabled type="radio" name="pins" value="" style="width:auto;"></div>
                    <div class="pinTableCellR pinColorDual"><input type="radio" name="pins" value="15" style="width:auto;"> 10 - GPIO15 - RxD</div>
                </div>
                <div class="pinTableRow">
                    <div class="pinTableCellL pinColorGPIO">GPIO17 - 11 <input type="radio" name="pins" value="17" style="width:auto;"></div>
                    <div class="pinTableCellR pinColorGPIO"><input type="radio" name="pins" value="18" style="width:auto;"> 12 - GPIO18</div>
                </div>
                <div class="pinTableRow">
                    <div class="pinTableCellL pinColorGPIO">GPIO27 - 13 <input type="radio" name="pins" value="27" style="width:auto;"></div>
                    <div class="pinTableCellR pinColorGround"><input disabled type="radio" name="pins" value="" style="width:auto;"> 14 - Ground</div>
                </div>
                <div class="pinTableRow">
                    <div class="pinTableCellL pinColorGPIO">GPIO22 - 15 <input type="radio" name="pins" value="22" style="width:auto;"></div>
                    <div class="pinTableCellR pinColorGPIO"><input type="radio" name="pins" value="23" style="width:auto;"> 16 - GPIO23</div>
                </div>
                <div class="pinTableRow">
                    <div class="pinTableCellL pinColorPower">3.3V Power - 17 <input disabled type="radio" name="pins" value="" style="width:auto;"></div>
                    <div class="pinTableCellR pinColorGPIO"><input type="radio" name="pins" value="24" style="width:auto;"> 18 - GPIO24</div>
                </div>
                <div class="pinTableRow">
                    <div class="pinTableCellL pinColorDual">MOSI - GPIO10 - 19 <input type="radio" name="pins" value="10" style="width:auto;"></div>
                    <div class="pinTableCellR pinColorGround"><input disabled type="radio" name="pins" value="" style="width:auto;"> 20 - Ground</div>
                </div>
                <div class="pinTableRow">
                    <div class="pinTableCellL pinColorDual">MISO - GPIO09 - 21 <input type="radio" name="pins" value="9" style="width:auto;"></div>
                    <div class="pinTableCellR pinColorGPIO"><input type="radio" name="pins" value="25" style="width:auto;"> 22 - GPIO25</div>
                </div>
                <div class="pinTableRow">
                    <div class="pinTableCellL pinColorDual">SCLK - GPIO11 - 23 <input type="radio" name="pins" value="11" style="width:auto;"></div>
                    <div class="pinTableCellR pinColorDual"><input type="radio" name="pins" value="8" style="width:auto;"> 24 - GPIO8 - CE0</div>
                </div>
                <div class="pinTableRow">
                    <div class="pinTableCellL pinColorGround">Ground - 25 <input disabled type="radio" name="pins" value="" style="width:auto;"></div>
                    <div class="pinTableCellR pinColorDual"><input type="radio" name="pins" value="7" style="width:auto;"> 26 - GPIO7 - CE1</div>
                </div>
                <div class="pinTableRow">
                    <div class="pinTableCellL pinColorSD">SD - 27 <input disabled type="radio" name="pins" value="" style="width:auto;"></div>
                    <div class="pinTableCellR pinColorSD"><input disabled type="radio" name="pins" value="" style="width:auto;"> 28 - SC</div>
                </div>
                <div class="pinTableRow">
                    <div class="pinTableCellL pinColorGPIO">GPIO05 - 29 <input type="radio" name="pins" value="5" style="width:auto;"></div>
                    <div class="pinTableCellR pinColorGround"><input disabled type="radio" name="pins" value="" style="width:auto;"> 30 - Ground</div>
                </div>
                <div class="pinTableRow">
                    <div class="pinTableCellL pinColorGPIO">GPIO06 - 31 <input type="radio" name="pins" value="6" style="width:auto;"></div>
                    <div class="pinTableCellR pinColorGPIO"><input type="radio" name="pins" value="12" style="width:auto;"> 32 - GPIO12</div>
                </div>
                <div class="pinTableRow">
                    <div class="pinTableCellL pinColorGPIO">GPIO13 - 33 <input type="radio" name="pins" value="13" style="width:auto;"></div>
                    <div class="pinTableCellR pinColorGround"><input disabled type="radio" name="pins" value="" style="width:auto;"> 34 - Ground</div>
                </div>
                <div class="pinTableRow">
                    <div class="pinTableCellL pinColorGPIO">GPIO19 - 35 <input type="radio" name="pins" value="19" style="width:auto;"></div>
                    <div class="pinTableCellR pinColorGPIO"><input type="radio" name="pins" value="16" style="width:auto;"> 36 - GPIO16</div>
                </div>
                <div class="pinTableRow">
                    <div class="pinTableCellL pinColorGPIO">GPIO26 - 37 <input type="radio" name="pins" value="26" style="width:auto;"></div>
                    <div class="pinTableCellR pinColorGPIO"><input type="radio" name="pins" value="20" style="width:auto;"> 38 - GPIO20</div>
                </div>
                <div class="pinTableRow">
                    <div class="pinTableCellL pinColorGround">Ground - 39 <input disabled type="radio" name="pins" value="" style="width:auto;"></div>
                    <div class="pinTableCellR pinColorGPIO"><input type="radio" name="pins" value="21" style="width:auto;"> 40 - GPIO21</div>
                </div>
            </form></div>
        </div>
    </div>
    <div class="form-row" id="node-set-pwm">
        <label>&nbsp;&nbsp;&nbsp;&nbsp;<span data-i18n="rpi-gpio.label.type"></span></label>
        <select id="node-input-out" style="width: 250px;">
            <option value="out" data-i18n="rpi-gpio.digout"></option>
            <option value="pwm" data-i18n="rpi-gpio.pwmout"></option>
        </select>
    </div>
    <div class="form-row" id="node-set-tick">
        <label>&nbsp;</label>
        <input type="checkbox" id="node-input-set" style="display: inline-block; width: auto; vertical-align: top;">
        <label for="node-input-set" style="width: 70%;"><span data-i18n="rpi-gpio.label.initpin"></span></label>
    </div>
    <div class="form-row" id="node-set-state">
        <label for="node-input-level">&nbsp;</label>
        <select id="node-input-level" style="width: 250px;">
            <option value="0" data-i18n="rpi-gpio.initpin0"></option>
            <option value="1" data-i18n="rpi-gpio.initpin1"></option>
        </select>
    </div>
    <div class="form-row" id="node-set-freq">
        <label for="node-input-freq"> <span data-i18n="rpi-gpio.label.freq"></span></label>
        <input type="text" id="node-input-freq" placeholder="100"> Hz
    </div>
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="common.label.name"></span></label>
        <input type="text" id="node-input-name" data-i18n="[placeholder]common.label.name">
    </div>
    <div class="form-tips" id="pin-tip"><span data-i18n="[html]rpi-gpio.tip.pin"></span></div>
    <div class="form-tips" id="dig-tip"><span data-i18n="[html]rpi-gpio.tip.dig"></span></div>
    <div class="form-tips" id="pwm-tip"><span data-i18n="[html]rpi-gpio.tip.pwm"></span></div>
</script>

<script type="text/x-red" data-help-name="rpi-gpio out">
    <p>Raspberry Pi output node. Can be used in Digital or PWM modes.
    <h3>Inputs</h3>
    <dl class="message-properties">
        <dt>payload <span class="property-type">number | string | boolean</span></dt>
    </dl>
    <h3>Details</h3>
    <p>Digital mode - expects a <code>msg.payload</code> with either a 0 or 1 (or true or false),
    and will set the selected physical pin high or low depending on the value passed in.</p>
    <p>The initial value of the pin at deploy time can also be set to 0 or 1.</p>
    <p>PWM mode - expects an input value of a number 0 - 100. It can be floating point.</p>
    <p>PWM mode can be used to drive a servo using input values between 10 and 20 only,
    but will accept floating point values.
    The GPIO2 pin is best for this as it uses hardware to do the PWM. For better servo support
    consider the alternative node-red-node-pi-gpiod node.</p>
    <p>Requires the RPi.GPIO python library version 0.5.10 (or better) in order to work.</p>
</script>

<script type="text/javascript">
    var bcm2pin = {
        "2":"3", "3":"5", "4":"7", "14":"8", "15":"10", "17":"11", "18":"12", "27":"13", "22":"15",
        "23":"16", "24":"18", "10":"19", "9":"21", "25":"22", "11":"23", "8":"24", "7":"26",
        "5":"29", "6":"31", "12":"32", "13":"33", "19":"35", "16":"36", "26":"37", "20":"38", "21":"40"
    };
    var pinsInUse = {};
    RED.nodes.registerType('rpi-gpio out',{
        category: 'Raspberry Pi',
        color:"#c6dbef",
        defaults: {
            name: { value:"" },
            pin: { value:"",required:true,validate:RED.validators.number() },
            set: { value:"" },
            level: { value:"0" },
            freq: {value:""},
            out: { value:"out" }
        },
        inputs:1,
        outputs:0,
        icon: "rpi.png",
        info: function() {
            if ( Object.keys(pinsInUse).length !== 0 ) {
                return "**Pins in use** : "+Object.keys(pinsInUse);
            }
            else { return ""; }
        },
        align: "right",
        label: function() {
            if (this.out === "pwm") { return this.name || "PWM: "+bcm2pin[this.pin]; }
            else if (this.out === "ser") { return this.name || "Servo: "+bcm2pin[this.pin]; }
            else {
                var suf = "";
                if (this.set == true) { suf = (this.level === "1") ? " ¹" : " ₀"; }
                return this.name||"PIN: "+ bcm2pin[this.pin] + suf ;
            }
        },
        labelStyle: function() {
            return this.name?"node_label_italic":"";
        },
        inputLabels: function() { return "GPIO"+this.pin; },
        oneditprepare: function() {
            var pinnow = this.pin;
            var pintip = this._("rpi-gpio.tip.pin");
            var pinname = this._("rpi-gpio.pinname");
            var alreadyuse = this._("rpi-gpio.alreadyuse");
            var alreadyset = this._("rpi-gpio.alreadyset");
            if (!$("#node-input-out").val()) { $("#node-input-out").val("out"); }

            $.getJSON('rpi-pins/'+this.id,function(data) {
                pinsInUse = data || {};
                $('#pin-tip').html(pintip + Object.keys(data));
            });

            $("#node-input-pin").change(function() {
                if ($("#node-input-pin").val()) {
                    $("#pinform input[value="+$("#node-input-pin").val()+"]").prop('checked', true);
                }
                var pinnew = $("#node-input-pin").val();
                if ((pinnew) && (pinnew !== pinnow)) {
                    if (pinsInUse.hasOwnProperty(pinnew)) {
                        RED.notify(pinname+" "+pinnew+" "+alreadyuse,"warn");
                    }
                    pinnow = pinnew;
                }
            });

            $("#node-input-out").change(function() {
                var newtype = $("#node-input-out").val();
                if ((pinsInUse.hasOwnProperty(pinnow)) && (pinsInUse[pinnow] !== newtype)) {
                    RED.notify(pinname+" "+pinnow+" "+alreadyset+" "+pinsInUse[pinnow],"error");
                }
            });

            var hidestate = function () {
                if ($("#node-input-out").val() === "pwm") {
                    $('#node-set-tick').hide();
                    $('#node-set-state').hide();
                    $('#node-input-set').prop('checked', false);
                    $("#dig-tip").hide();
                    $("#pwm-tip").show();
                    $('#node-set-freq').show();
                }
                else {
                    $('#node-set-tick').show();
                    $("#dig-tip").show();
                    $("#pwm-tip").hide();
                    $('#node-set-freq').hide();
                }
            };
            $("#node-input-out").change(function () { hidestate(); });
            hidestate();

            var setstate = function () {
                if ($('#node-input-set').is(":checked")) {
                    $("#node-set-state").show();
                } else {
                    $("#node-set-state").hide();
                }
            };
            $("#node-input-set").change(function () { setstate(); });
            setstate();

            $('#pinform input').on('change', function() {
                this.pin = $("#pinform input[type='radio']:checked").val();
                $("#node-input-pin").val(this.pin);
            });
        }
    });
</script>

<script type="text/x-red" data-template-name="rpi-mouse">
    <div class="form-row">
        <label for="node-input-butt"><i class="fa fa-circle"></i> <span data-i18n="rpi-gpio.label.button"></span></label>
        <select type="text" id="node-input-butt" style="width: 250px;">
            <option value="1" data-i18n="rpi-gpio.left"></option>
            <option value="2" data-i18n="rpi-gpio.right"></option>
            <option value="4" data-i18n="rpi-gpio.middle"></option>
            <option value="7" data-i18n="rpi-gpio.any"></option>
         </select>
    </div>
    <br/>
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="common.label.name"></span></label>
        <input type="text" id="node-input-name" data-i18n="[placeholder]common.label.name">
    </div>
</script>

<script type="text/x-red" data-help-name="rpi-mouse">
    <p>Raspberry Pi mouse button node. Requires a USB mouse.</p>
    <h3>Outputs</h3>
    <dl class="message-properties">
        <dt>payload <span class="property-type">number</span></dt>
        <dd>1 or 0 when the selected mouse button is pressed and released.</dd>
        <dt>button <span class="property-type">number</span></dt>
        <dd>1, 2, 4 corresponding to left, right and middle buttons, so you
        can work out which button or combination was pressed.</dd>
        <dt>topic <span class="property-type">string</span></dt>
        <dd>set to <code>pi/mouse</code></dd>
    </dl>
</script>

<script type="text/javascript">
    RED.nodes.registerType('rpi-mouse',{
        category: 'Raspberry Pi',
        color:"#c6dbef",
        defaults: {
            name: { value:"" },
            butt: { value:"1",required:true }
        },
        inputs:0,
        outputs:1,
        icon: "rpi.png",
        label: function() {
            var na = this._("rpi-gpio.label.pimouse");
            if (this.butt === "1") { na += " "+this._("rpi-gpio.label.left"); }
            if (this.butt === "2") { na += " "+this._("rpi-gpio.label.right"); }
            if (this.butt === "4") { na += " "+this._("rpi-gpio.label.middle"); }
            return this.name||na;
        },
        labelStyle: function() {
            return this.name?"node_label_italic":"";
        }
    });
</script>

<script type="text/x-red" data-template-name="rpi-keyboard">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="common.label.name"></span></label>
        <input type="text" id="node-input-name" data-i18n="[placeholder]common.label.name">
    </div>
</script>

<script type="text/x-red" data-help-name="rpi-keyboard">
    <p>Raspberry Pi keyboard handling node. Requires a USB keyboard.</p>
    <h3>Outputs</h3>
    <dl class="message-properties">
        <dt>payload <span class="property-type">number</span></dt>
        <dd>contains the keycode value</dd>
        <dt>action <span class="property-type">string</span></dt>
        <dd>set to "up", "down", or "repeat"</dd>
        <dt>topic <span class="property-type">string</span></dt>
        <dd>set to <code>pi/key</code></dd>
    </dl>
</script>

<script type="text/javascript">
    RED.nodes.registerType('rpi-keyboard',{
        category: 'Raspberry Pi',
        color:"#c6dbef",
        defaults: {
            name: { value:"" }
        },
        inputs:0,
        outputs:1,
        icon: "rpi.png",
        label: function() {
            return this.name || this._("rpi-gpio.label.pikeyboard");
        },
        labelStyle: function() {
            return this.name?"node_label_italic":"";
        }
    });
</script>
